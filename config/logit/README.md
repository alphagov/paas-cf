# What

This directory contains the logstash filters to be used in logit.io to parse
the logs from our Cloud Foundry platform.

The scripts are based on
 - Upstream [logsearch filters](https://github.com/logsearch/logsearch-boshrelease/tree/develop/src/logsearch-config/src/logstash-filters)
 - [logsearch-for-cloudfoundry filters](https://github.com/alphagov/paas-logsearch-for-cloudfoundry)
 - Custom filters added adhoc by us.

These filters can be manually updated in the logit interface. To generate the filters or update them, follow the instructions in this file.

## How to generate the Logit Logstash filters

Run `scripts/generate.sh` from the paas-cf directory.

### 10_base.conf

This contains the base filters.

Concatenate the following files:

* [filters_pre.conf.erb](https://github.com/cloudfoundry-community/logsearch-boshrelease/blob/v205.0.1/jobs/parser/templates/config/filters_pre.conf.erb)
* [redact_passwords.conf](https://github.com/cloudfoundry-community/logsearch-boshrelease/blob/v205.0.1/src/logsearch-config/src/logstash-filters/snippets/redact_passwords.conf)
* [syslog_standard.conf](https://github.com/cloudfoundry-community/logsearch-boshrelease/blob/v205.0.1/src/logsearch-config/src/logstash-filters/snippets/syslog_standard.conf)

Apply the following changes:
 - remove the ERB template blocks
 - replace the first alter {} block with this:
   ```
   mutate {
     add_field => [ "type", "syslog" ]
   }
   ```
  - remove all ruby {} blocks

### 20_logsearch_for_cloudfoudry.conf

This contains the logstash filters from the logsearch-for-cloudfoundry project. This file can be generated by following these steps

1. Install dependencies
   ```
   cd paas-logsearch-for-cloudfoundry/src/logsearch-config
   docker run --rm -ti -v $(pwd):/mnt -w /mnt jruby:9.1-alpine bash
   bundle install
   ```

1. Generate the upstream Logstash filters
   ```
   bundle exec rake build
   cat target/logstash-filters-default.conf
   ```

Remove the following filter as we can't change the index name in Logit:

```
mutate {
  add_field => { "[@metadata][index]" => "%{@index_type}" }
}
```

### 30_custom_filters.conf

You can add custom filters in this file.
