resource "datadog_monitor" "cve-notifier" {
  count              = "${var.enable_cve_notifier}"
  name               = "${format("%s cve-notifier", var.env)}"
  type               = "service check"
  message            = "${format("{{#is_alert}} No data from cve-notifier. Check the cve-notifier application in org admin space admin, account: %s. It should be up and running. {{/is_alert}}", var.aws_account)}"
  escalation_message = "${format("{{#is_alert}} Still no data from cve-notifier. Check the cve-notifier application in org admin space admin, account: %s. It should be up and running. {{/is_alert}}", var.aws_account)}"
  no_data_timeframe  = "130"
  query              = "${format("'cve.notifier.ok'.over('host:cve-notifier-%s').last(1).count_by_status()", var.env)}"

  thresholds {
    warning  = "1"
    critical = "1"
  }

  require_full_window = true

  tags {
    "deployment" = "${var.env}"
    "service"    = "${var.env}_monitors"
  }
}

resource "datadog_monitor" "cve-notifier-reporter" {
  count             = "${var.enable_cve_notifier}"
  name              = "New CVE Detected"
  type              = "event alert"
  message           = "${format("New CVE has been found on https://pivotal.io/security @%s", var.support_email)}"
  no_data_timeframe = "180"
  query             = "events('priority:all tags:service:pivotal').rollup('count').last('1h') >= 1"
  notify_no_data    = false

  thresholds {
    ok       = "1"
    warning  = "1"
    critical = "1"
  }

  tags {
    "deployment" = "${var.env}"
    "service"    = "${var.env}_monitors"
  }
}
