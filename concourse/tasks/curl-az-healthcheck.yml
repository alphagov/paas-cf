---
platform: linux
image_resource:
  type: registry-image
  source:
    repository: ghcr.io/alphagov/paas/curl-ssl
    tag: 826b547c6411b0fd22ac0b07bde11eed5523879c
params:
  AVAILABILITY_ZONE:
  ENABLE_AZ_HEALTHCHECK:
inputs:
  - name: terraform-variables
  - name: paas-cf
run:
  path: ash
  args:
    - -e
    - -c
    - |
      echo "Checking the ability to perform tests on ${AVAILABILITY_ZONE}..."

      if [ "${ENABLE_AZ_HEALTHCHECK:-}" = "false" ]; then
        echo "Availability Zone Healthchecks instances do not exist."
        exit 0
      fi

      echo "Loading up the terraform outputs..."
      HEALTHCHECK_IP=$(cat "terraform-variables/${AVAILABILITY_ZONE}")
      export HEALTHCHECK_IP

      # shellcheck disable=SC2154
      echo "Attempting to get a response from the healthcheck in ${AVAILABILITY_ZONE} at ${HEALTHCHECK_IP}..."
      # if the DISABLE_AZ_HEALTHCHECK_BLOCK flag is set, we don't care about the response
      if [ "${DISABLE_AZ_HEALTHCHECK_BLOCK:-}" = "true" ]; then
        echo "Availability Zone Healthchecks have been disabled."
        exit 0
      fi

      for attempt in $(seq 12); do
        echo "Attempt ${attempt}..."
        if curl -s -o /dev/null -w "%{http_code}" "http://${HEALTHCHECK_IP}:3000" -m 5 | grep -q 200; then
          echo "Availability Zone Healthchecks are up. Double checking..."
          if curl -s -o /dev/null -w "%{http_code}" "http://${HEALTHCHECK_IP}:3000" -m 5 | grep -q 200; then
            echo "Success!"
            exit 0
          else
            echo "Double check failed!"
            exit 1
          fi
        fi
        sleep 5
      done

      echo "Availability Zone Healthchecks are not working in this zone."
      exit 1