resources:
  - name: delete-timer
    type: time
    source:
      start: 20:00 -0000
      stop: 6:00 -0000
      interval: 2h

  - name: bosh-secrets
    type: s3-iam
    source:
      bucket: {{state_bucket}}
      region_name: {{aws_region}}
      versioned_file: bosh-secrets.yml

jobs:
  - name: delete
    serial: true
    plan:
    - get: delete-timer
      trigger: true
    - get: bosh-secrets
    - task: delete-deployment
      config:
        inputs:
        - name: delete-timer
        - name: bosh-secrets
        image: docker:///concourse/bosh-deployment-resource
        run:
          path: sh
          args:
          - -e
          - -c
          # The following sleep monstrosity deterministically sleeps for a
          # period of time between 0-20mins in order to prevent all our
          # deletion jobs running at the same time. See the commit message for
          # how it works.
          - |
            sum=$(echo {{deploy_env}} | md5sum);
            short=${sum:0:15};
            decimal=$((0x$short));
            sleeptime=$((${decimal##-} % 60*20));
            echo "Sleeping for $sleeptime seconds before deletion.."; sleep $sleeptime && 
            bosh_password=$(awk '$1~/bosh_admin_password/ {print $2}' bosh-secrets/bosh-secrets.yml)
            bosh -n -t https://10.0.0.6:25555 -u admin -p "${bosh_password}" delete deployment {{deploy_env}} --force
