resources:
  - name: paas-cf
    type: git
    source:
      uri: https://github.com/alphagov/paas-cf.git
      branch: {{branch_name}}

  - name: bosh-cf-tfstate
    type: s3-iam
    source:
      bucket: {{state_bucket}}
      region_name: {{aws_region}}
      versioned_file: bosh-cf.tfstate

  - name: concourse-tfstate
    type: s3-iam
    source:
      bucket: {{state_bucket}}
      versioned_file: concourse.tfstate
      region_name: {{aws_region}}

  - name: bosh-init-state
    type: s3-iam
    source:
      bucket: {{state_bucket}}
      region_name: {{aws_region}}
      versioned_file: bosh-manifest-state.json

  - name: bosh-manifest
    type: s3-iam
    source:
      bucket: {{state_bucket}}
      region_name: {{aws_region}}
      versioned_file: bosh-manifest.yml

  - name: vpc-tfstate
    type: s3-iam
    source:
      bucket: {{state_bucket}}
      versioned_file: vpc.tfstate
      region_name: {{aws_region}}

  - name: pipeline-trigger
    type: semver-iam
    source:
      bucket: {{state_bucket}}
      region_name: {{aws_region}}
      key: {{pipeline_trigger_file}}

  - name: bosh-secrets
    type: s3-iam
    source:
      bucket: {{state_bucket}}
      region_name: {{aws_region}}
      versioned_file: bosh-secrets.yml

jobs:
  - name: delete-deployment
    serial_groups: [ destroy ]
    serial: true
    plan:
      - aggregate:
        - get: bosh-secrets
        - get: paas-cf
        - get: bosh-init-state
      - task: delete-deployment
        config:
          inputs:
          - name: bosh-secrets
          - name: paas-cf
          - name: bosh-init-state
          image: docker:///governmentpaas/bosh-cli
          run:
            path: sh
            args:
            - -e
            - -c
            - |
              if  grep director_id bosh-init-state/bosh-manifest-state.json; then
                ./paas-cf/concourse/scripts/bosh_login.sh bosh-secrets/bosh-secrets.yml
                bosh -n delete deployment {{deploy_env}}
              fi
      - put: pipeline-trigger
        params: {bump: patch}

  - name: bosh-init-delete
    serial: true
    plan:
      - aggregate:
        - get: pipeline-trigger
          trigger: true
          passed: [ delete-deployment ]
        - get: paas-cf
          passed: [ delete-deployment ]
        - get: bosh-cf-tfstate
        - get: bosh-secrets
          passed: [ delete-deployment ]
        - get: bosh-init-state
          passed: [ delete-deployment ]
        - get: bosh-manifest
      - task: bosh-init-microbosh
        config:
          image: docker:///governmentpaas/bosh-init
          run:
            path: sh
            args:
            - -e
            - -c
            - |
              cp bosh-init-state/bosh-manifest-state.json bosh-manifest/bosh-manifest-state.json
              bosh-init delete bosh-manifest/bosh-manifest.yml
              # If the delete is successful, the file will be missing
              [ -f "bosh-manifest/bosh-manifest-state.json" ] || \
                  cp paas-cf/concourse/init_files/bosh-init-state.json.tpl bosh-manifest/bosh-manifest-state.json
          inputs:
          - name: paas-cf
          - name: bosh-manifest
          - name: bosh-init-state
        ensure:
          put: bosh-init-state
          params:
            file: bosh-init-microbosh/bosh-manifest/bosh-manifest-state.json

  - name: bosh-terraform-destroy
    serial: true
    plan:
    - aggregate:
      - get: pipeline-trigger
        trigger: true
        passed: [ bosh-init-delete ]
      - get: paas-cf
        passed: [ bosh-init-delete ]
      - get: bosh-init-state
        passed: [ bosh-init-delete ]
        trigger: true
      - get: vpc-tfstate
      - get: concourse-tfstate
      - get: bosh-cf-tfstate
        passed: [ bosh-init-delete ]
    - task: terraform-variables
      config:
        image: docker:///ruby#2.2.3-slim
        run:
          path: sh
          args:
          - -e
          - -c
          - |
            ruby paas-cf/concourse/scripts/extract_tf_vars_from_terraform_state.rb \
            < bosh-cf-tfstate/bosh-cf.tfstate > terraform-variables/bosh-cf.tfvars.sh
            ruby paas-cf/concourse/scripts/extract_tf_vars_from_terraform_state.rb \
            < vpc-tfstate/vpc.tfstate \
            > terraform-variables/vpc.tfvars.sh
            ruby paas-cf/concourse/scripts/extract_tf_vars_from_terraform_state.rb \
            < concourse-tfstate/concourse.tfstate \
            > terraform-variables/concourse.tfvars.sh
        inputs:
        - name: paas-cf
        - name: vpc-tfstate
        - name: bosh-cf-tfstate
        - name: concourse-tfstate
        outputs:
        - name: terraform-variables
    - task: terraform-destroy
      config:
        image: docker:///governmentpaas/docker-terraform
        params:
          DEPLOY_ENV: {{deploy_env}}
          AWS_DEFAULT_REGION: {{aws_region}}
        inputs:
        - name: paas-cf
        - name: terraform-variables
        - name: bosh-cf-tfstate
        run:
          path: sh
          args:
          - -e
          - -c
          - |
            . terraform-variables/vpc.tfvars.sh
            . terraform-variables/concourse.tfvars.sh
            . terraform-variables/bosh-cf.tfvars.sh

            terraform destroy -force -var env={{deploy_env}} -var-file=paas-cf/terraform/{{aws_account}}.tfvars \
              -state=bosh-cf-tfstate/bosh-cf.tfstate -state-out=bosh-cf.tfstate paas-cf/terraform/bosh-cloudfoundry
      ensure:
        put: bosh-cf-tfstate
        params:
          file: terraform-destroy/bosh-cf.tfstate

