meta:
  rds_broker:
    medium_postgres_rds_properties:
      db_instance_class: "db.m4.large"
      engine: "postgres"
      engine_version: "9.5.2"
      storage_type: "gp2"
      allocated_storage: 20
      auto_minor_version_upgrade: true
      multi_az: false
      publicly_accessible: false
      copy_tags_to_snapshot: true
      skip_final_snapshot: true
      backup_retention_period: 0
      db_subnet_group_name: (( grab terraform_outputs.rds_broker_dbs_subnet_group ))
      vpc_security_group_ids:
        - (( grab terraform_outputs.rds_broker_dbs_security_group_id ))
      db_parameter_group_name: (( grab terraform_outputs.rds_broker_postgres95_db_parameter_group ))

releases:
  - name: aws-broker
    version: 0.0.3

resource_pools:
  - name: rds_broker_z1
    network: cf1
    stemcell: (( grab meta.stemcell ))
    env: (( grab meta.default_env ))
    cloud_properties:
      instance_type: m3.medium
      iam_instance_profile: rds-broker
      ephemeral_disk:
        size: 10240
        type: gp2
      availability_zone: (( grab meta.zones.z1 ))
      security_groups:
        - (( grab terraform_outputs.rds_broker_db_clients_security_group ))
        - (( grab terraform_outputs.default_security_group ))

jobs:
  - name: rds_broker_z1
    instances: 1
    resource_pool: rds_broker_z1
    templates:
      - name: rds-broker
        release: aws-broker
    networks:
      - name: cf1
        static_ips: (( static_ips(15) ))
    properties:
      rds-broker:
        aws_access_key_id: ""
        aws_secret_access_key: ""
        aws_region: "eu-west-1"
        password: (( grab secrets.rds_broker_admin_password ))
        db_prefix: "rdsbroker"
        catalog:
          services:
            - id: "ce71b484-d542-40f7-9dd4-5526e38c81ba"
              name: "postgres"
              description: "AWS RDS PostgreSQL service"
              bindable: true
              tags:
                - "postgres"
                - "relational"
              metadata:
                displayName: "AWS RDS Postgres"
                imageUrl: ""
                longDescription: "AWS RDS postgres service"
                providerDisplayName: "Amazon Web Services"
                documentationUrl: "https://aws.amazon.com/documentation/rds/"
                supportUrl: "https://forums.aws.amazon.com/forum.jspa?forumID=60"
              plan_updateable: false
              plans:
                - id: "9b882524-ab58-4c18-b501-d2a3f4619104"
                  name: "M-dedicated-9.5"
                  description: "20GB Storage, Dedicated Instance, Max 500 Concurrent Connections. Postgres Version 9.5"
                  free: false
                  metadata:
                    costs:
                      - amount:
                          usd: 0.201
                        unit: "HOUR"
                    bullets:
                      - "Dedicated Postgres 9.5 server"
                      - "AWS RDS"
                  rds_properties:
                    inject: (( inject meta.rds_broker.medium_postgres_rds_properties ))

                - id: "bf5b99c2-7990-4b66-b341-1bb83566d76e"
                  name: "M-HA-dedicated-9.5"
                  description: "20GB Storage, Dedicated Instance, Highly Available, Max 500 Concurrent Connections. Postgres Version 9.5"
                  free: false
                  metadata:
                    costs:
                      - amount:
                          usd: 0.402
                        unit: "HOUR"
                    bullets:
                      - "Dedicated Postgres 9.5 server"
                      - "AWS RDS"
                  rds_properties:
                    inject: (( inject meta.rds_broker.medium_postgres_rds_properties ))
                    multi_az: true

properties:
  cc:
    security_group_definitions:
      - name: rds_broker_instances
        rules:
          - protocol: tcp
            destination: (( grab terraform_outputs.aws_backing_service_cidr_all ))
            ports: '5432'

    default_running_security_groups:
      - (( append ))
      - "rds_broker_instances"
    default_staging_security_groups:
      - (( append ))
      - "rds_broker_instances"
