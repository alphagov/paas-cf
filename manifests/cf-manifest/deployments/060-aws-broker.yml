releases:
  - name: aws-broker
    version: 0.0.3

jobs:
  - name: rds_broker_z1
    instances: 1
    resource_pool: rds_broker_z1
    templates:
      - name: rds-broker
        release: aws-broker
    properties:
      rds-broker:
        aws_access_key_id: ""
        aws_secret_access_key: ""
        aws_region: "eu-west-1"
        password: (( grab secrets.rds_broker_admin_password ))
        db_prefix: "rdsbroker"
        catalog:
          services:
            - id: "ce71b484-d542-40f7-9dd4-5526e38c81ba"
              name: "postgres"
              description: "AWS RDS PostgreSQL service"
              bindable: true
              tags:
                - "postgres"
                - "relational"
              metadata:
                displayName: "AWS RDS Postgres"
                imageUrl: ""
                longDescription: "AWS RDS postgres service"
                providerDisplayName: "Amazon Web Services"
                documentationUrl: "https://aws.amazon.com/documentation/rds/"
                supportUrl: "https://forums.aws.amazon.com/forum.jspa?forumID=60"
              plan_updateable: false
              plans:
                - id: "5b8282cf-a669-4ffc-b426-c169a7bbfc71"
                  name: "temporary-test-plan"
                  description: "RDS Postgres"
                  free: true
                  metadata:
                    costs:
                      - amount:
                          usd: 0.180
                        unit: "HOUR"
                    bullets:
                      - "Dedicated Postgres 9.4 server"
                      - "Postgres 9.4"
                      - "AWS RDS"
                  rds_properties:
                    db_instance_class: "db.m3.medium"
                    engine: "postgres"
                    engine_version: "9.4.7"
                    storage_type: "gp2"
                    allocated_storage: 10
                    auto_minor_version_upgrade: true
                    multi_az: false
                    publicly_accessible: false
                    copy_tags_to_snapshot: true
                    skip_final_snapshot: true
                    backup_retention_period: 0
                    db_subnet_group_name: (( grab terraform_outputs.rds_broker_dbs_subnet_group ))
                    vpc_security_group_ids:
                      - (( grab terraform_outputs.rds_broker_dbs_security_group_id ))
                - id: "9b882524-ab58-4c18-b501-d2a3f4619104"
                  name: "M-dedicated-9.5"
                  description: "20GB Storage, Dedicated Instance, 20 Concurrent Connections. Postgres Version 9.5"
                  free: false
                  metadata:
                    costs:
                      - amount:
                          usd: 0.201
                        unit: "HOUR"
                    bullets:
                      - "Dedicated Postgres 9.5 server"
                      - "AWS RDS"
                  rds_properties:
                    db_instance_class: "db.m4.large"
                    engine: "postgres"
                    engine_version: "9.5.2"
                    storage_type: "gp2"
                    allocated_storage: 20
                    auto_minor_version_upgrade: true
                    multi_az: false
                    publicly_accessible: false
                    copy_tags_to_snapshot: true
                    skip_final_snapshot: true
                    backup_retention_period: 0
                    db_subnet_group_name: (( grab terraform_outputs.rds_broker_dbs_subnet_group ))
                    vpc_security_group_ids:
                      - (( grab terraform_outputs.rds_broker_dbs_security_group_id ))

properties:
  cc:
    security_group_definitions:
      - name: rds_broker_instances
        rules:
          - protocol: tcp
            destination: (( grab terraform_outputs.aws_backing_service_cidr_all ))
            ports: '5432'

    default_running_security_groups:
      - (( append ))
      - "rds_broker_instances"
    default_staging_security_groups:
      - (( append ))
      - "rds_broker_instances"
