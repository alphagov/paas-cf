meta:
  consul_agent_job: &consul_agent_job
    name: consul_agent
    release: consul
    consumes: {consul_client: nil, consul_server: nil, consul_common: nil}
    properties:
      consul: &consul_agent_job_properties_consul
        agent: &consul_agent_job_properties_consul_agent
          domain: cf.internal
          servers:
            lan: ((consul_static_ips))
          dns_config:
            allow_stale: true
            max_stale: "30s"
          log_level: null
        ca_cert: ((certs_bosh_ca_cert))
        agent_cert: ((certs_consul_agent_cert))
        agent_key: ((certs_consul_agent_key))
        encrypt_keys: ((secrets_consul_encrypt_keys))
        server_cert: ((certs_consul_server_cert))
        server_key: ((certs_consul_server_key))

  metron_agent_job: &metron_agent_job
    release: loggregator
    properties:
      loggregator:
        tls:
          ca_cert: ((certs_bosh_ca_cert))
          metron:
            cert: ((certs_metron_cert))
            key: ((certs_metron_key))
      metron_agent:
        deployment: ((environment))

  statsd_injector_job: &statsd_injector_job
    name: statsd_injector
    release: statsd-injector
    properties:
      loggregator:
        tls:
          ca_cert: ((certs_bosh_ca_cert))
          statsd_injector:
            cert: ((certs_statsd_injector_cert))
            key: ((certs_statsd_injector_key))

  cfdot_job: &cfdot_job
    name: cfdot
    release: diego
    properties:
      diego:
        cfdot:
          bbs:
            ca_cert: ((certs_bosh_ca_cert))
            client_cert: ((certs_bbs_client_cert))
            client_key: ((certs_bbs_client_key))
            use_ssl: true

instance_groups:
  - name: consul
    azs: [z1, z2, z3]
    jobs:
      - name: consul_agent
        release: consul
        consumes: {consul_client: nil, consul_server: nil, consul_common: nil}
        properties:
          consul:
            <<: *consul_agent_job_properties_consul
            agent:
              <<: *consul_agent_job_properties_consul_agent
              mode: server
      - name: datadog-consul-agent-server
        release: datadog-for-cloudfoundry
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: metron_agent
        <<: *metron_agent_job
    instances: 3
    persistent_disk_type: consul
    vm_type: small
    stemcell: default
    networks:
      - name: cf
        static_ips: ((consul_static_ips))
    update:
      serial: true

  - name: nats
    azs: [z1, z2]
    jobs:
      - name: consul_agent
        <<: *consul_agent_job
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: nats
        consumes: {nats: nil}
        release: nats
        properties:
          nats:
            port: ((nats_port))
            machines: ((nats_static_ips))
            debug: false
            trace: false
            monitor_port: 0
            prof_port: 0
            user: nats_user
            password: ((secrets_nats_password))
      - name: datadog-nats
        release: datadog-for-cloudfoundry
        properties:
          nats:
            port: ((nats_port))
      - name: metron_agent
        <<: *metron_agent_job
    instances: 2
    vm_type: medium
    stemcell: default
    networks:
      - name: cf
        static_ips: ((nats_static_ips))

  - name: adapter
    azs: [z1, z2, z3]
    instances: 3
    vm_type: small
    stemcell: default
    networks:
      - name: cf
    jobs:
      - name: consul_agent
        <<: *consul_agent_job
        consumes: {consul_client: nil, consul_server: nil, consul_common: nil, consul: nil}
      - name: metron_agent
        <<: *metron_agent_job
      - name: adapter
        release: cf-syslog-drain
        properties:
          scalablesyslog:
            adapter:
              tls:
                ca: ((certs_bosh_ca_cert))
                cert: ((certs_scalablesyslog_adapter_cert))
                key: ((certs_scalablesyslog_adapter_key))
                cn: scalablesyslog_adapter
              logs:
                addr: reverse-log-proxy.service.cf.internal:8082
            adapter_rlp:
              tls:
                ca: ((certs_bosh_ca_cert))
                cert: ((certs_reverse_log_proxy_cert))
                key: ((certs_reverse_log_proxy_key))
                cn: reverse_log_proxy

  - name: diego-api
    migrated_from:
    - name: database
    azs: [z1, z2]
    jobs:
      - name: consul_agent
        <<: *consul_agent_job
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: datadog-bbs
        release: datadog-for-cloudfoundry
        properties:
          bbs:
            url: "https://bbs.service.cf.internal:8889/v1/actual_lrp_groups/list"
            client_cert: "/var/vcap/jobs/cfdot/config/certs/cfdot/client.crt"
            client_key: "/var/vcap/jobs/cfdot/config/certs/cfdot/client.key"
            ca_cert: "/var/vcap/jobs/cfdot/config/certs/cfdot/ca.crt"
      - name: bbs
        release: diego
        properties:
          diego:
            bbs:
              active_key_label: key-2017-01
              encryption_keys:
                - label: key-2017-01
                  passphrase: ((secrets_bbs_encryption_key))
              ca_cert: ((certs_bosh_ca_cert))
              server_cert: ((certs_bbs_server_cert))
              server_key: ((certs_bbs_server_key))
              auctioneer:
                api_location: auctioneer.service.cf.internal:9016
                ca_cert: ((certs_bosh_ca_cert))
                client_cert: ((certs_auctioneer_client_cert))
                client_key: ((certs_auctioneer_client_key))
                require_tls: true
              etcd:
                machines: []
                ca_cert: ""
                client_cert: ""
                client_key: ""
                require_ssl: false
              rep:
                ca_cert: ((certs_bosh_ca_cert))
                client_cert: ((certs_rep_client_cert))
                client_key: ((certs_rep_client_key))
                require_tls: true
              sql:
                db_username: bbs
                db_password: ((secrets_cf_db_bbs_password))
                db_host: ((terraform_outputs_cf_db_address))
                db_port: 5432
                db_schema: bbs
                db_driver: postgres
              dropsonde_port: ((dropsonde_incoming_port))
              require_ssl: true
      - name: cfdot
        <<: *cfdot_job
      - name: metron_agent
        <<: *metron_agent_job
    instances: 2
    vm_type: medium
    vm_extensions:
      - cf_rds_client_sg
    stemcell: default
    networks:
      - name: cf
    update:
      serial: true

  - name: uaa
    azs: [z1, z2]
    jobs:
      - name: consul_agent
        release: consul
        consumes: {consul_client: nil, consul_server: nil, consul_common: nil}
        properties:
          consul:
            <<: *consul_agent_job_properties_consul
            agent:
              <<: *consul_agent_job_properties_consul_agent
              services:
                uaa: {}
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: uaa
        release: uaa
        properties:
          uaadb:
            db_scheme: postgresql
            address: ((terraform_outputs_cf_db_address))
            port: 5432
            roles:
              - tag: admin
                name: uaa
                password: ((secrets_cf_db_uaa_password))
            databases:
              - tag: uaa
                name: uaa
                citext: true

          uaa:
            url: https://uaa.((system_domain))
            issuer: https://uaa.((system_domain))
            require_https: false
            logging_level: INFO
            scim:
              userids_enabled: true
              users:
                - name: admin
                  password: ((secrets_uaa_admin_password))
                  groups:
                    - scim.write
                    - scim.read
                    - scim.invite
                    - openid
                    - cloud_controller.admin
                    - cloud_controller.admin_read_only
                    - doppler.firehose
              groups:
                cloud_controller.global_auditor: 'Global Auditor read only group'


            port: 8080
            ssl:
              port: 8443
            sslCertificate: ((certs_uaa_internal_cert))
            sslPrivateKey: ((certs_uaa_internal_key))

            password:
              policy:
                minLength: 8

            admin:
              client_secret: ((secrets_uaa_admin_client_secret))

            jwt:
              policy:
                active_key_id: default
                keys:
                  default:
                    signingKey: ((certs_uaa_jwt_signing_key))
                  previous:
                    signingKey: ((certs_uaa_jwt_signing_old_key))
                refreshTokenValiditySeconds: 604800
                global:
                  refreshTokenValiditySeconds: 604800

            clients:
              login:
                override: true
                scope: openid,oauth.approvals
                authorities: oauth.login,scim.write,clients.read,notifications.write,critical_notifications.write,emails.write,scim.userids,password.write
                authorized-grant-types: authorization_code,client_credentials,refresh_token
                redirect-uri: https://login.((system_domain))
                secret: ((secrets_uaa_clients_login_secret))
              cf:
                override: true
                authorized-grant-types: password,refresh_token
                scope: cloud_controller.read,cloud_controller.write,openid,password.write,cloud_controller.admin,cloud_controller.admin_read_only,cloud_controller.global_auditor,scim.read,scim.write,scim.invite,doppler.firehose,uaa.user,routing.router_groups.read,routing.router_groups.write
                authorities: uaa.none
                access-token-validity: 600
                refresh-token-validity: 604800
                secret: ''
              notifications:
                override: true
                authorities: cloud_controller.admin,scim.read
                authorized-grant-types: client_credentials
                secret: ((secrets_uaa_clients_notifications_secret))
              doppler:
                override: true
                authorities: uaa.resource
                authorized-grant-types: client_credentials
                secret: ((secrets_uaa_clients_doppler_secret))
              cloud_controller_username_lookup:
                override: true
                authorities: scim.userids
                authorized-grant-types: client_credentials
                secret: ((secrets_uaa_clients_cloud_controller_username_lookup_secret))
              cc_service_key_client:
                override: true
                authorities: credhub.read,credhub.write
                authorized-grant-types: client_credentials
                secret: ((secrets_uaa_clients_cc_service_key_client_secret))
              cc_routing:
                override: true
                authorities: routing.router_groups.read
                authorized-grant-types: client_credentials
                secret: ((secrets_uaa_cc_routing_secret))
              gorouter:
                override: true
                authorities: routing.routes.read
                authorized-grant-types: client_credentials
                secret: ((secrets_uaa_clients_gorouter_secret))
              tcp_emitter:
                override: true
                authorities: routing.routes.write,routing.routes.read
                authorized-grant-types: client_credentials
                secret: ''
              tcp_router:
                override: true
                authorities: routing.routes.read
                authorized-grant-types: client_credentials
                secret: ''
              ssh-proxy:
                override: true
                authorized-grant-types: authorization_code
                autoapprove: true
                redirect-uri: https://login.((system_domain))/login
                scope: openid,cloud_controller.read,cloud_controller.write,cloud_controller.admin
                secret: ((secrets_uaa_clients_ssh_proxy_secret))
              graphite-nozzle:
                override: true
                access-token-validity: 1209600
                authorized-grant-types: authorization_code,client_credentials,refresh_token
                secret: ((secrets_uaa_clients_firehose_password))
                scope: openid,oauth.approvals,doppler.firehose
                authorities: oauth.login,doppler.firehose
                redirect-uri: https://login.((system_domain))/login
              paas-metrics:
                override: true
                access-token-validity: 1209600
                authorized-grant-types: client_credentials,refresh_token
                secret: ((secrets_uaa_clients_paas_metrics_secret))
                scope: openid,oauth.approvals,cloud_controller.global_auditor
                authorities: oauth.login,cloud_controller.global_auditor
                redirect-uri: https://login.((system_domain))
              paas-billing:
                override: true
                access-token-validity: 1209600
                authorized-grant-types: client_credentials,refresh_token,authorization_code
                autoapprove: true
                secret: ((secrets_uaa_clients_paas_billing_secret))
                scope: openid,oauth.approvals,cloud_controller.admin_read_only,cloud_controller.read,cloud_controller.global_auditor,cloud_controller.admin
                authorities: cloud_controller.admin_read_only,uaa.resource
                redirect-uri: https://paas-billing.((app_domain))/oauth/callback
              paas-admin:
                override: true
                authorized-grant-types: authorization_code,refresh_token
                autoapprove: true
                secret: ((secrets_uaa_clients_paas_admin_secret))
                scope: openid,oauth.approvals,cloud_controller.read,cloud_controller.admin_read_only,cloud_controller.global_auditor
                authorities: uaa.none
                redirect-uri: https://paas-admin.((app_domain))/auth/cloudfoundry/callback
              cc-service-dashboards:
                override: true
                secret: ((secrets_uaa_clients_cc_service_dashboards_password))
                authorities: clients.read,clients.write,clients.admin
                authorized-grant-types: client_credentials
                redirect-uri: https://login.((system_domain))
              cdn_broker:
                override: true
                authorities: uaa.none
                authorized-grant-types: password
                scope: cloud_controller.admin_read_only
                secret: ((secrets_uaa_clients_cdn_broker_secret))
              user_invitation:
                override: true
                authorities: oauth.login,scim.write,emails.write,scim.userids
                authorized-grant-types: password,refresh_token
                redirect-uri: "https://www.cloud.service.gov.uk/next-steps?success"
                scope: openid,password.write,scim.read,scim.write,scim.invite,uaa.user
                secret: ((secrets_uaa_clients_login_secret))
            zones:
              internal:
                hostnames:
                - uaa.service.cf.internal
          login:
            saml:
              activeKeyId: key1
              keys:
                key1:
                  key: ((certs_saml_key))
                  passphrase: ""
                  certificate: ((certs_saml_cert))
            smtp:
              host: ((terraform_outputs_ses_smtp_host))
              port: 587
              from_address: "gov-uk-paas-support@digital.cabinet-office.gov.uk"
              user: ((terraform_outputs_ses_smtp_aws_access_key_id))
              password: ((terraform_outputs_ses_smtp_password))
              auth: true
              starttls: true
            self_service_links_enabled: true
            links:
              passwd: "https://login.((system_domain))/forgot_password"
              signup: "https://www.cloud.service.gov.uk/signup"
              homeRedirect: "https://www.cloud.service.gov.uk/next-steps?account-updated"
            branding:
              company_name: "GOV.UK PaaS"
            asset_base_url: "https://paas-uaa-assets.((terraform_outputs_cf_apps_domain))"

      - name: metron_agent
        <<: *metron_agent_job
      - name: statsd_injector
        <<: *statsd_injector_job
      - name: route_registrar
        release: routing
        properties:
          nats:
            machines: ((nats_static_ips))
            port: ((nats_port))
            user: nats_user
            password: ((secrets_nats_password))
          route_registrar:
            routes:
              - name: uaa
                registration_interval: 10s
                health_check:
                  name: cf_uaa_health_check
                  script_path: /var/vcap/jobs/uaa/bin/health_check
                  timeout: "5s"
                port: 8081
                tls_port: 8443
                server_cert_domain_san: "uaa.service.cf.internal"
                tags:
                  component: uaa
                uris:
                  - "uaa.((system_domain))"
                  - "login.((system_domain))"

    instances: 2
    vm_type: medium
    vm_extensions:
      - cf_rds_client_sg
    stemcell: default
    networks:
      - name: cf

  - name: api
    azs: [z1, z2]
    jobs:
      - name: consul_agent
        release: consul
        consumes: {consul_client: nil, consul_server: nil, consul_common: nil}
        properties:
          consul:
            <<: *consul_agent_job_properties_consul
            agent:
              <<: *consul_agent_job_properties_consul_agent
              services:
                cloud_controller_ng: {}
      - name: cloud_controller_ng
        release: capi
        consumes: {nats: nil}
      - name: metron_agent
        <<: *metron_agent_job
      - name: statsd_injector
        release: statsd-injector
      - name: file_server
        release: diego
      - name: cc_uploader
        release: capi
      - name: java-buildpack
        release: java-buildpack
      - name: go-buildpack
        release: go-buildpack
      - name: binary-buildpack
        release: binary-buildpack
      - name: nodejs-buildpack
        release: nodejs-buildpack
      - name: ruby-buildpack
        release: ruby-buildpack
      - name: php-buildpack
        release: php-buildpack
      - name: python-buildpack
        release: python-buildpack
      - name: staticfile-buildpack
        release: staticfile-buildpack
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: datadog-cc
        release: datadog-for-cloudfoundry
    instances: 2
    vm_type: large
    vm_extensions:
      - 64g_ephemeral_disk
      - cf_cc_instance_profile
      - cf_cc_security_groups
      - cf_cc_elb
    stemcell: default
    networks:
      - name: cf

  - name: cc-worker
    migrated_from:
    - name: api_worker
    azs: [z1, z2]
    jobs:
      - name: consul_agent
        <<: *consul_agent_job
      - name: cloud_controller_worker
        release: capi
        consumes: {nats: nil}
      - name: metron_agent
        <<: *metron_agent_job
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: datadog-cc-worker
        release: datadog-for-cloudfoundry
    instances: 2
    vm_type: medium
    vm_extensions:
      - 64g_ephemeral_disk
      - cf_cc_instance_profile
      - cf_cc_security_groups
    stemcell: default
    networks:
      - name: cf

  - name: router
    azs: [z1, z2]
    jobs:
      - name: consul_agent
        release: consul
        consumes: {consul_client: nil, consul_server: nil, consul_common: nil}
        properties:
          consul:
            <<: *consul_agent_job_properties_consul
            agent:
              <<: *consul_agent_job_properties_consul_agent
              services:
                gorouter: {}
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: gorouter
        release: routing
        consumes: {nats: nil}
      - name: metron_agent
        <<: *metron_agent_job
      - name: haproxy
        release: paas-haproxy
      - name: datadog-router
        release: datadog-for-cloudfoundry
      - name: racoon
        release: ipsec
      - name: datadog-ipsec
        release: datadog-for-cloudfoundry
    instances: 2
    vm_type: router
    stemcell: default
    networks:
      - name: router
    properties:
      racoon:
        ports:
        - name: router
          targets: ((terraform_outputs_cell_subnet_cidr_blocks))
    update:
      serial: true

  - name: scheduler
    azs: [z1, z2, z3]
    instances: 3
    vm_type: medium
    stemcell: default
    networks:
      - name: cf
    jobs:
      - name: consul_agent
        <<: *consul_agent_job
        consumes: {consul_client: nil, consul_server: nil, consul_common: nil, consul: nil}
      - name: metron_agent
        <<: *metron_agent_job
      - name: cfdot
        release: diego
      - name: auctioneer
        release: diego
      - name: cloud_controller_clock
        release: capi
      - name: statsd_injector
        release: statsd-injector
      - name: tps
        release: capi
      - name: ssh_proxy
        release: diego
      - name: scheduler
        release: cf-syslog-drain
    vm_extensions:
      - ssh_proxy_elb
      - cf_rds_client_sg
    properties:
      scalablesyslog:
        scheduler:
          api:
            url: https://cloud-controller-ng.service.cf.internal:9023
          tls:
            client:
              ca: ((certs_bosh_ca_cert))
              cert: ((certs_scalablesyslog_adapter_scheduler_client_cert))
              key: ((certs_scalablesyslog_adapter_scheduler_client_key))
              adapter_cn: "scalablesyslog_adapter"
            api:
              ca: ((certs_bosh_ca_cert))
              cert: ((certs_scalablesyslog_adapter_scheduler_api_cert))
              key: ((certs_scalablesyslog_adapter_scheduler_api_key))
              cn: "cloud-controller-ng.service.cf.internal"
    update:
      serial: true

  - name: doppler
    azs: [z1, z2, z3]
    jobs:
      - name: consul_agent
        release: consul
        consumes: {consul_client: nil, consul_server: nil, consul_common: nil}
        properties:
          consul:
            <<: *consul_agent_job_properties_consul
            agent:
              <<: *consul_agent_job_properties_consul_agent
              services:
                doppler: {}
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: doppler
        release: loggregator
        provides: {doppler: {as: doppler}}
      - name: metron_agent
        <<: *metron_agent_job
    instances: 3
    vm_type: medium
    stemcell: default
    networks:
      - name: cf

  - name: diego-cell
    migrated_from:
    - name: cell
    azs: [z1, z2, z3]
    jobs:
      - name: consul_agent
        <<: *consul_agent_job
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: rep
        release: diego
      - name: garden
        release: garden-runc
      - name: cflinuxfs2-rootfs-setup
        release: cflinuxfs2
      - name: cfdot
        release: diego
      - name: metron_agent
        <<: *metron_agent_job
      - name: route_emitter
        release: diego
        properties:
          diego:
            route_emitter:
              local_mode: true
              dropsonde_port: ((dropsonde_incoming_port))
              bbs:
                api_location: bbs.service.cf.internal:8889
                ca_cert: ((certs_bosh_ca_cert))
                client_cert: ((certs_bbs_client_cert))
                client_key: ((certs_bbs_client_key))
                require_ssl: true
              nats:
                machines: ((nats_static_ips))
                user: nats_user
                password: ((secrets_nats_password))
                port: ((nats_port))
      - name: datadog-route-emitter
        release: datadog-for-cloudfoundry
      - name: datadog-rep
        release: datadog-for-cloudfoundry
      - name: datadog-garden
        release: datadog-for-cloudfoundry
      - name: racoon
        release: ipsec
      - name: datadog-ipsec
        release: datadog-for-cloudfoundry
    instances: ((cell_instances))
    vm_type: cell
    stemcell: default
    networks:
      - name: cell
    properties:
      racoon:
        ports:
        - name: cell
          targets: ((terraform_outputs_router_subnet_cidr_blocks))
      tls:
        ca_cert: ((certs_bosh_ca_cert))
        cert: ((certs_cc_client_cert))
        key: ((certs_cc_client_key))

  - name: log-api
    migrated_from:
    - name: loggregator_trafficcontroller
    azs: [z1, z2]
    jobs:
      - name: consul_agent
        release: consul
        consumes: {consul_client: nil, consul_server: nil, consul_common: nil}
        properties:
          consul:
            <<: *consul_agent_job_properties_consul
            agent:
              <<: *consul_agent_job_properties_consul_agent
              services:
                loggregator_trafficcontroller: {}
                reverse_log_proxy: {}
      - name: datadog-consul-agent-client
        release: datadog-for-cloudfoundry
      - name: loggregator_trafficcontroller
        release: loggregator
        consumes: {doppler: {from: doppler}}
      - name: metron_agent
        <<: *metron_agent_job
      - name: reverse_log_proxy
        release: loggregator
    provides:
      reverse_log_proxy: {as: reverse_log_proxy, shared: true}
    instances: 2
    vm_type: medium
    vm_extensions:
      - cf_doppler_elbs
    stemcell: default
    networks:
      - name: cf
    properties:
      loggregator:
        uaa:
          client_secret: ((secrets_uaa_clients_doppler_secret))
        reverse_log_proxy:
          egress:
            port: 8082
      consul:
        agent:
          services:
            loggregator_trafficcontroller: {}
            reverse_log_proxy: {}
    update:
      serial: true
